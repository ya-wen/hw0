<!DOCTYPE html>
<html>
<head>
<style>
#info {
    position: absolute;
    top: 0px;
    width: 100%;
    padding: 10px;
    text-align: center;
    color: #ffff00
}
body{
	overflow:hidden;
}
</style>


</head>

<body>


<script src="js/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/jquery-2.1.4.min.js"></script>
<script src='js/threex.text.js'></script>
<script src="js/droid_serif_bold.typeface.js"></script>
<!--div style="width:60%; float:left; background:pink; margin:10px">
    <div style="height: 0; padding-bottom:100%;">asdfasd</div>
</div-->
<!--audio id="bgm" autoplay loop style="display:none">
<source src="sounds/busy.mp3" type='audio/mp3'>
</audio-->
<div>
   
</div>
<hr>
<div id="mainscreen" style="float:left; background:pink;margin:3px; width:45vw; height:45vw">
<canvas id="screen"> </canvas>
   
</div>

</div>
<div style="float:left; margin-left: 10px; width:32vw;">
User Name:
    <input id="user" style="width:100%" type="text" value="user name">
    <br/>
    <br/>
	

	<button id="login">
        login 
	</button>
	<br/>
	<button id="start">
        start
	</button>

    <p id='greeting'></p>
</div>
 








<script id="vertexShader" type="x-shader/x-vertex">
    varying vec2 vUv;
    
    void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
</script>
<script id="fragmentShader" type="x-shader/x-fragment">
    uniform float time;
    varying vec2 vUv;
    
    float rand(vec2 co) {
        return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
    }

    void main(void) {
        // Divide the coordinates into a grid of squares
    vec2 v = vUv*10.0; //gl_FragCoord.xy / 20.0;
        // Calculate a pseudo-random brightness value for each square
        vec3 brightness = vec3(fract(rand(floor(v)) + time), fract(rand(floor(v)) + time / 3.), fract(rand(floor(v)) + time / 5.));
        // Reduce brightness in pixels away from the square center
        brightness *= 0.5 - length(fract(v) - vec2(0.5, 0.5));
        gl_FragColor = vec4(brightness.r * 4.0, brightness.g * brightness.b * 2., brightness.b - brightness.r + 0.2, 1.0);
    }
</script>




<script>

var startgame=0;
var camera, scene, renderer, geometry, material, mesh, controls;
var clock = new THREE.Clock();
var pucks = [];
var records = [];
var memember;
var which = 1;
var mouse = new THREE.Vector2();
var thegate=35;
var deadth=0;
var meshMaterialc;
var onRenderFcts= [];
var Puck = function () {
    this.vel = new THREE.Vector3();
    this.pos = new THREE.Vector3();
    this.pColor = new THREE.Color();
    this.mesh = new THREE.Mesh();
    this.pointLight = new THREE.PointLight(0xffffff, 0.3);
	var life=1;
};

Puck.prototype.update = function (dt) {
    this.pos.add(this.vel.clone().multiplyScalar(dt));

    this.mesh.position.copy(this.pos);
    this.pointLight.position.set(this.pos.x, 10, this.pos.z);
    this.pointLight.color = this.pColor;
    this.mesh.material.color = this.pColor;

};

Puck.prototype.collision = function () {
	var boardpos=mouse.x*140;
   if (this.pos.x > 100) {
			this.pos.x = 100;
			  this.pColor.setHSL(Math.random(), Math.random(), Math.random() / 2 + 0.5);
			this.vel.set(-this.vel.x, 0, this.vel.z);
		}
		else if (this.pos.x < -100) {
			this.pos.x = -100;
			  this.pColor.setHSL(Math.random(), Math.random(), Math.random() / 2 + 0.5);
			this.vel.set(-this.vel.x, 0, this.vel.z);
		}
		if (this.pos.z > 100) {
			this.pos.z = 100;
			if(this.pos.x<=thegate  &&this.pos.x>=(-thegate))
			{
				
				if(Math.abs(boardpos-this.pos.x)<=35)
				{
					//console.log(mouse.x-this.pos.x);
					  this.pColor.setHSL(Math.random(), Math.random(), Math.random() / 2 + 0.5);
					this.vel.set(this.vel.x, 0, -this.vel.z);
				}
				else
				{
					//console.log("out");
					if(this.mesh.visible ==true)
					{
					deadth++;
					this.mesh.visible = false;
					this.pointLight.intensity = 0;
					}
				}
			}
			else
			{
				  this.pColor.setHSL(Math.random(), Math.random(), Math.random() / 2 + 0.5);
				this.vel.set(this.vel.x, 0, -this.vel.z);
			}
		}
		else if (this.pos.z < -100) {
			this.pos.z = -100;
			
			if(this.pos.x<=thegate  &&this.pos.x>=(-thegate))
			{
				if(Math.abs(boardpos-this.pos.x)<=35)
				{
					//console.log(mouse.x-this.pos.x);
					this.vel.set(this.vel.x, 0, -this.vel.z);
				}
				else
				{
					if(this.mesh.visible ==true)
					{
					deadth++;
					this.mesh.visible = false;
					this.pointLight.intensity = 0;
					}
				}
			}
			else
			{
				this.vel.set(this.vel.x, 0, -this.vel.z);
			}
		}

}

init();
animate();

$("#login").click(function () {
    var name = document.getElementById('user').value;
    alert(name + " is playing");

    var result = searchUser(name);
    if (result >= 0) {
        document.getElementById('greeting').innerHTML = "Your high score: " + result;
    } else {
        document.getElementById('greeting').innerHTML = "Welcome!";
    }
});

function searchUser(name) {
    for (var i = 0; i < records.length; i++) {
        if (records[i].name === name) {
            return records[i].score;
        }
    }
    return -1;
}
function mallocolumn()
{
    var geometryc = new THREE.CylinderGeometry(5,5,20,200);

		meshMaterialc = new THREE.ShaderMaterial({
        uniforms: {
            time: {
                type: 'f',
                value: 1.0
            }
        },
        vertexShader: document.getElementById('vertexShader').textContent,
        fragmentShader: document.getElementById('fragmentShader').textContent
    });

		var meshc = new THREE.Mesh(geometry, meshMaterialc);
		meshc.rotation.z=Math.PI/2;
		meshc.position.set(105, 15, 105)
	//	scene = new THREE.Scene();
		scene.add(meshc);
		var meshc2 = new THREE.Mesh(geometry, meshMaterialc);
		meshc2.rotation.z=Math.PI/2;
		meshc2.position.set(-105, 15, 105)
	//	scene = new THREE.Scene();
		scene.add(meshc2);
		var meshc3 = new THREE.Mesh(geometry, meshMaterialc);
		meshc3.rotation.z=Math.PI/2;
		meshc3.position.set(105, 15, -105)
	//	scene = new THREE.Scene();
		scene.add(meshc3);
		var meshc4 = new THREE.Mesh(geometry, meshMaterialc);
		meshc4.rotation.z=Math.PI/2;
		meshc4.position.set(-105, 15, -105)
	//	scene = new THREE.Scene();
		scene.add(meshc4);
}
var meshw1,meshw2,meshw3,meshw4;
function words()
{

	meshw1	= new THREEx.Text('press')
	meshw1.scale.multiplyScalar(20)
	meshw1.position.z	= -50
	meshw1.rotation.x=-Math.PI/2;
	scene.add(meshw1)
	meshw2	= new THREEx.Text('start')
	meshw2.scale.multiplyScalar(20)
	meshw2.rotation.x=-Math.PI/2;
	scene.add(meshw2)
	meshw3	= new THREEx.Text('to play!')
	meshw3.scale.multiplyScalar(20)
	meshw3.rotation.x=-Math.PI/2;
	meshw3.position.z	= 50
	scene.add(meshw3)
}
function words3()
{
	var second=Math.floor(clock.getElapsedTime());
	meshw1	= new THREEx.Text('game over')
	meshw1.scale.multiplyScalar(20)
	meshw1.position.z	= -50
	meshw1.rotation.x=-Math.PI/2;
	scene.add(meshw1)
	meshw2	= new THREEx.Text('scord=')
	meshw2.scale.multiplyScalar(20)
	meshw2.rotation.x=-Math.PI/2;
	scene.add(meshw2)
	meshw3	= new THREEx.Text(second)
	meshw3.scale.multiplyScalar(20)
	meshw3.rotation.x=-Math.PI/2;
	meshw3.position.z	= 50
	scene.add(meshw3)
	
}

function words2()
{
	scene.remove(meshw2);
	scene.remove(meshw4);
	var second=Math.floor(clock.getElapsedTime());
	meshw2	= new THREEx.Text(second)
	meshw2.scale.multiplyScalar(20)
	meshw2.rotation.x=-Math.PI/2;
	scene.add(meshw2)
	meshw4	= new THREEx.Text(deadth);
	meshw4.scale.multiplyScalar(20)
	meshw4.rotation.x=-Math.PI/2;
	meshw4.position.x	= 60
	meshw4.position.z	= 50
	scene.add(meshw4)
	
}
$("#start").click(function(){
	
	startgame=1;
	scene.remove(meshw1);
	scene.remove(meshw2);
	scene.remove(meshw3);
	meshw1	= new THREEx.Text('scords')
	meshw1.scale.multiplyScalar(20)
	meshw1.position.z	= -50
	meshw1.rotation.x=-Math.PI/2;
	scene.add(meshw1)
	meshw2	= new THREEx.Text(0)
	meshw2.scale.multiplyScalar(20)
	meshw2.rotation.x=-Math.PI/2;
	scene.add(meshw2)
	meshw3	= new THREEx.Text('outpuck');
	meshw3.scale.multiplyScalar(20)
	meshw3.rotation.x=-Math.PI/2;
	meshw3.position.x	= -40
	meshw3.position.z	= 50
	scene.add(meshw3)
	meshw4	= new THREEx.Text(0);
	meshw4.scale.multiplyScalar(20)
	meshw4.rotation.x=-Math.PI/2;
	meshw4.position.x	= 60
	meshw4.position.z	= 50
	scene.add(meshw4)
  
});
function mallocwall()
{
  geometry = new THREE.BoxGeometry(70, 30, 10);
   geometry2 = new THREE.BoxGeometry(220, 30, 10);
    material = new THREE.MeshBasicMaterial({
        transparent: true,
        color: 0xffffff,
        opacity: 0.4
    });
	 material2 = new THREE.MeshBasicMaterial({
        transparent: true,
        color: 0x0000ff,
        opacity: 0.4
    });
/*========================================================*/
/*                   the  board                           */
/*========================================================*/
    mesh1 = new THREE.Mesh(geometry, material);
    mesh1.position.set(0, 15, 105);
    scene.add(mesh1);
    mesh2 = mesh1.clone();
    mesh2.position.set(0, 15, -105);
    scene.add(mesh2);
   // mesh3 = mesh1.clone();
   
	
	/*========================================================*/
	/*                   the wall                          */
	/*========================================================*/
	mesh12 = new THREE.Mesh(geometry, material2);
    mesh12.position.set(80, 15, 105);
    scene.add(mesh12);
    mesh22 = mesh12.clone();
    mesh22.position.set(80, 15, -105);
    scene.add(mesh22);
    mesh32 = mesh12.clone();
    /*mesh32.rotation.y = Math.PI / 2;
    mesh32.position.set(105, 15, 80);
    scene.add(mesh32);
    mesh42 = mesh12.clone();
    mesh42.rotation.y = Math.PI / 2;
    mesh42.position.set(-105, 15, 80);
    scene.add(mesh42);*/
	/*========================================================*/
	/*                   the wall                          */
	/*========================================================*/
	mesh13 = new THREE.Mesh(geometry, material2);
    mesh13.position.set(-80, 15, 105);
    scene.add(mesh13);
    mesh23 = mesh13.clone();
    mesh23.position.set(-80, 15, -105);
    scene.add(mesh23);
    mesh33 = new THREE.Mesh(geometry2, material2);
    mesh33.rotation.y = Math.PI / 2;
    mesh33.position.set(105, 15, 0);
    scene.add(mesh33);
    mesh43 =new THREE.Mesh(geometry2, material2);
    mesh43.rotation.y = Math.PI / 2;
    mesh43.position.set(-105, 15, 0);
    scene.add(mesh43);
}

function newPuck() {
    var puck = new Puck();
    puck.pos = new THREE.Vector3(0, 1, 0);
    puck.vel = new THREE.Vector3(150 * (Math.random() * 2 - 1), 0, 170 * (Math.random() * 2 - 1));
    puck.pColor = new THREE.Color(0xff0000);
    puck.mesh = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 2, 20),
    new THREE.MeshBasicMaterial());
    puck.mesh.material.color = puck.pColor;
    scene.add(puck.mesh);
    scene.add(puck.pointLight);
    return puck;
}

function setscreen1()
{
	 var screen = document.getElementById("screen");
    var mainscreen = document.getElementById("mainscreen");

     renderer = new THREE.WebGLRenderer({
        canvas: screen,
        antialias: true
    });
    var ww = mainscreen.clientWidth;
    var hh = mainscreen.clientHeight;
    renderer.setSize(ww, hh);
    renderer.setClearColor(0x222222);
    scene = new THREE.Scene();
}
function getdate()
{
	var objStr = localStorage.getItem("myObj");
    var obj = null;
    try{
        obj = JSON.parse(objStr);
		memember=obj.number;
		for(var i=0;i<ballnumber;i++)
		{
			posx[i]=obj.posx[i];
			posy[i]=obj.posy[i];
			posz[i]=obj.posz[i];
			metatex[i]=obj.tex[i];
		}
        alert(obj.number);
    }catch(e){
        //throw a exception if parse null to json
        alert(objStr);
    }
}
function init() {
   //scene = new THREE.Scene();
	setscreen1();
	var ww = mainscreen.clientWidth;
    var hh = mainscreen.clientHeight;
	camera = new THREE.PerspectiveCamera(50, ww/hh, 1, 1000);
    camera.position.y = 500;
    scene.add(camera);
	mallocwall();
	mallocolumn();
	words();
    geometry = new THREE.BoxGeometry(220, 30, 10);
    material = new THREE.MeshBasicMaterial({
        transparent: true,
        color: 0xffffff,
        opacity: 0.4
    });

    
    ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200, 130, 130),
    new THREE.MeshLambertMaterial({
        color: 0xffffff
    }));

    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    var ambientLight = new THREE.AmbientLight(0x111111);
    scene.add(ambientLight);
    pucks.push(newPuck());

    for (var i = 1; i < 10; i++) {
        var thispuck = newPuck();
        thispuck.mesh.visible = false;
        thispuck.pointLight.intensity = 0;
        pucks.push(thispuck);
    }

    // start first new puck
    setTimeout (startNewPuck, 1000);
	window.addEventListener ('resize', onWindowResize, false);
	renderer.domElement.addEventListener ('mousemove', onDocumentMouseMove, false);
}

function startNewPuck() {
   // console.log (which);
   if(startgame==1)
   {
    pucks[which].mesh.visible = true;
    pucks[which].pointLight.intensity = 0.3;
    which++;
	}
    if (which <= 9)
        setTimeout (startNewPuck, 1000);
}

function onDocumentMouseMove( event ) {
	event.preventDefault();
	var ww = mainscreen.clientWidth;
    var hh = mainscreen.clientHeight;
	mouse.x = ( event.clientX /ww ) * 2 - 1;
	mouse.y = - ( event.clientY /hh) * 2 + 1;

	// tracer: find intersection on xz plane
	var depth0 = new THREE.Vector3( mouse.x, mouse.y, 0.0 ).unproject( camera );
	var depth1 = new THREE.Vector3( mouse.x, mouse.y, 1.0 ).unproject( camera );

	var t = depth0.y / (depth0.y - depth1.y);
	var x = depth0.x + t * (depth1.x - depth0.x);
	var z = depth0.z + t * (depth1.z - depth0.z);
	//target.set (x,0,z);
}
function onWindowResize ()
{
	var ww = mainscreen.clientWidth;
    var hh = mainscreen.clientHeight;
	camera.aspect = ww / hh;
	camera.updateProjectionMatrix();
	renderer.setSize (ww, hh);
}
function mousemove()
{
    mesh1.position.set(mouse.x*2*35, 15, 105);
	mesh2.position.set(mouse.x*2*35, 15, -105);
	mesh13.position.x=-(thegate-70)-105;
	mesh23.position.x=-(thegate-70)-105;
	mesh12.position.x=(thegate-70)+105;
	mesh22.position.x=(thegate-70)+105;
   // mesh2.position.set(mouse[0], 15, -105);
   // mesh3.position.set(105, 15, mouse[1]);
   // mesh4.position.set(-105, 15, mouse[1]);
  // console.log(mouse.x);
}
var dt;
function deadevent()
{
		var name = document.getElementById('user').value;
		var second=Math.floor(clock.getElapsedTime());
		
		if(second<records.score)second=records.score;
		//alert("game over");
		//alert("scord="+second);
		scene.remove(meshw1);
		scene.remove(meshw2);
		scene.remove(meshw3);
		scene.remove(meshw4);
		words3();
		records.push({
        name: name,
        score:second
		});
		deadth++;
		startgame=0;
}
function animate() {
	if(startgame==1)
	{
	words2();
    dt = clock.getDelta();
	if(thegate<105 )
	{
		thegate+=dt;
	}
    pucks.forEach(function (puck) {
        puck.update(dt);
        puck.collision();
    });
	if(deadth==5)
	{
		deadevent();
	}
    
	mousemove();
	meshMaterialc.uniforms.time.value += dt * 2;
	}
	controls.update();
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

</script>
</body>

</html>



